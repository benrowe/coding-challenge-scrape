<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard</title>
    <link href="/dist/css/index.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <h1 class="text-2xl font-bold mb-4">Analytics Dashboard</h1>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-white p-4 rounded shadow">
                <h2 class="text-xl font-semibold mb-2">Total Articles</h2>
                <p id="total-articles" class="text-2xl">0</p>
            </div>
            <div class="bg-white p-4 rounded shadow">
                <h2 class="text-xl font-semibold mb-2">Total Categories</h2>
                <p id="total-categories" class="text-2xl">0</p>
            </div>
        </div>
        <div class="bg-white p-4 rounded shadow mt-4">
            <h2 class="text-xl font-semibold mb-2">Trending Categories</h2>
            <table class="min-w-full bg-white">
                <thead>
                    <tr>
                        <th class="px-4 py-2 border-b">Category</th>
                        <th class="px-4 py-2 border-b">Count</th>
                    </tr>
                </thead>
                <tbody id="trending-categories">
                    <!-- Trending categories will be populated here -->
                </tbody>

            </table>
        </div>
        <div class="bg-white p-4 rounded shadow mt-4">
            <h2 class="text-xl font-semibold mb-2">Top 5 Category Breakdown</h2>
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="relative w-64 h-64 md:w-80 md:h-80">
                    <canvas id="category-chart" ></canvas>
                </div>
                <div id="legend" class="flex flex-col gap-4 w-full md:w-auto">

                </div>
            </div>

        </div>
        <div class="bg-white p-4 rounded shadow mt-4">
            <h2 class="text-xl font-semibold mb-2">Articles</h2>
            <table class="min-w-full bg-white">
                <thead>
                    <tr>
                        <th class="px-4 py-2 border-b">Title</th>
                        <th class="px-4 py-2 border-b">Summary</th>
                    </tr>
                </thead>
                <tbody id="articles-list">
                    <!-- Articles will be listed here -->
                </tbody>

            </table>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            fetch('/api')
                .then(response => response.json())
                .then(data => handleAnalyticsData(data))
                .catch(error => console.error('Error fetching analytics data:', error));
        });

        function handleAnalyticsData(data) {
            updateHeadlineStats(data);
            renderArticlesList(data.articles);

            const sortedCategories = sortCategoriesByCount(data.categories);
            renderCategoryList(sortedCategories);

            const chartData = prepareChartData(data.categories);
            drawCategoryChart(chartData);
        }

        function updateHeadlineStats(data) {
            document.getElementById('total-articles').textContent = data.articles.length;
            document.getElementById('total-categories').textContent = Object.keys(data.categories).length;
        }

        function sortCategoriesByCount(categories) {
            return Object.entries(categories).sort((a, b) => b[1] - a[1]);
        }

        function prepareChartData(categories) {
            // extract the top 5 categories and their counts
            // if there are more than 5, combine the rest into an "Other" category
            const categoryEntries = Object.entries(categories);
            const topFive = categoryEntries.slice(0, 5).map(([label, value]) => ({
                label,
                value,
                color: getRandomColor()
            }));

            const otherCount = categoryEntries.slice(5).reduce((sum, [, count]) => sum + count, 0);
            if (otherCount > 0) {
                topFive.push({
                    label: 'Other',
                    value: otherCount,
                    color: '#cccccc'
                });
            }

            return topFive;
        }

        function drawCategoryChart(chartData) {
            const canvas = document.getElementById('category-chart');
            const ctx = canvas.getContext('2d');
            const parent = canvas.parentElement;
            const size = Math.min(parent.offsetWidth, parent.offsetHeight);

            canvas.width = size;
            canvas.height = size;

            const centerX = size / 2;
            const centerY = size / 2;
            const radius = size * 0.45;
            const total = chartData.reduce((sum, item) => sum + item.value, 0);
            let currentAngle = -0.5 * Math.PI;

            clearLegend();

            chartData.forEach(item => {
                const sliceAngle = (item.value / total) * 2 * Math.PI;
                const endAngle = currentAngle + sliceAngle;

                drawSlice(ctx, centerX, centerY, radius, currentAngle, endAngle, item.color);
                drawLabel(ctx, centerX, centerY, radius, currentAngle, sliceAngle, item.label, item.value, total);
                appendLegendItem(item.label, item.value, total, item.color);

                currentAngle = endAngle;
            });
        }

        function drawSlice(ctx, cx, cy, radius, arcStart, arcEnd, colour) {
            ctx.beginPath();
            ctx.moveTo(cx, cy);
            ctx.arc(cx, cy, radius, arcStart, arcEnd);
            ctx.closePath();
            ctx.fillStyle = colour;
            ctx.fill();
        }

        function drawLabel(ctx, cx, cy, radius, arcStart, arcEnd, label, value, total) {
            const midAngle = arcStart + arcEnd / 2;
            const x = cx + (radius / 2) * Math.cos(midAngle);
            const y = cy + (radius / 2) * Math.sin(midAngle);
            const percentage = ((value / total) * 100).toFixed(1);

            ctx.fillStyle = '#000';
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(`${label} (${percentage}%)`, x, y);
        }

        function appendLegendItem(label, value, total, color) {
            const percentage = ((value / total) * 100).toFixed(1);
            const legend = document.getElementById('legend');
            const item = document.createElement('div');
            item.className = 'flex items-center gap-2';
            item.innerHTML = `
                <span class="w-4 h-4" style="background-color: ${color};"></span>
                <span>${label} (${percentage}%)</span>`;
            legend.appendChild(item);
        }

        function clearLegend() {
            const legend = document.getElementById('legend');
            legend.innerHTML = '';
        }

        function renderCategoryList(categories) {
            const list = document.getElementById('trending-categories');
            list.innerHTML = '';

            categories.forEach(([name, count]) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-2 border-b">${name}</td>
                    <td class="px-4 py-2 border-b">${count}</td>`;
                list.appendChild(row);
            });
        }

        function renderArticlesList(articles) {
            const list = document.getElementById('articles-list');
            list.innerHTML = '';

            articles.forEach(({ title, summary }) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-2 border-b">${title}</td>
                    <td class="px-4 py-2 border-b">${summary}</td>`;
                list.appendChild(row);
            });
        }

        function getRandomColor() {
            return '#' + Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0');
        }


    </script>

</body>
</html>
